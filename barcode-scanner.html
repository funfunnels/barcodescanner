<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="×§×•×¨× ×‘×¨×§×•×“×™× ×œ××ª×¨ Baby Land">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Baby Land Scanner">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>×§×•×¨× ×‘×¨×§×•×“×™× - Baby Land</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        #reader {
            width: 100%;
        }

        #reader video {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        #reader__scan_region {
            border-radius: 10px;
        }

        #reader__dashboard_section {
            display: none !important;
        }

        #reader__camera_selection {
            display: none !important;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }

        .barcode-result {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .barcode-result h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .barcode-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-right: 20px;
            color: #856404;
        }

        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ×§×•×¨× ×‘×¨×§×•×“×™×</h1>
        <p class="subtitle">Baby Land Event Scanner</p>

        <div class="instructions">
            <h3>×”×•×¨××•×ª ×©×™××•×©:</h3>
            <ul>
                <li>×œ×—×¥ ×¢×œ "×”×ª×—×œ ×¡×¨×™×§×”" ×œ×”×¤×¢×œ×ª ×”××¦×œ××”</li>
                <li>×›×•×•×Ÿ ××ª ×”×‘×¨×§×•×“ ×œ××¨×›×– ×”××¡×š</li>
                <li>×”×‘×¨×§×•×“ ×™×–×•×”×” ××•×˜×•××˜×™×ª ×•×™×™×©×œ×— ×œ××ª×¨ Baby Land</li>
            </ul>
        </div>

        <div class="controls">
            <button id="startBtn" onclick="startScanner()">×”×ª×—×œ ×¡×¨×™×§×”</button>
            <button id="stopBtn" onclick="stopScanner()" disabled>×¢×¦×•×¨ ×¡×¨×™×§×”</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px; color: #666;">
            <strong>××•</strong>
        </div>

        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 10px; text-align: center;">×”×–× ×” ×™×“× ×™×ª</h3>
            <div style="display: flex; gap: 10px;">
                <input 
                    type="text" 
                    id="manual-input" 
                    placeholder="×”×–×Ÿ ×‘×¨×§×•×“ ×™×“× ×™×ª"
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; font-family: 'Courier New', monospace;"
                    onkeypress="if(event.key === 'Enter') submitManualBarcode()"
                />
                <button onclick="submitManualBarcode()" style="white-space: nowrap;">×©×œ×—</button>
            </div>
        </div>

        <div id="status" class="status info">
            ×œ×—×¥ ×¢×œ "×”×ª×—×œ ×¡×¨×™×§×”" ××• ×”×–×Ÿ ×‘×¨×§×•×“ ×™×“× ×™×ª
        </div>

        <div id="scanner-container" class="hidden">
            <div id="reader"></div>
        </div>

        <div id="result" class="barcode-result hidden">
            <h3>×‘×¨×§×•×“ ×©×–×•×”×”:</h3>
            <div id="barcode-value" class="barcode-value"></div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>×©×•×œ×— ×œ××ª×¨ Baby Land...</p>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;
        let lastDetected = null;
        let lastDetectedTime = 0;

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        async function startScanner() {
            try {
                const scannerContainer = document.getElementById('scanner-container');
                scannerContainer.classList.remove('hidden');
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                updateStatus('×××ª×—×œ ××¦×œ××”...', 'info');

                // Initialize html5-qrcode scanner
                html5QrcodeScanner = new Html5Qrcode("reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 150 },
                    aspectRatio: 1.777778,
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.CODABAR,
                        Html5QrcodeSupportedFormats.ITF
                    ]
                };

                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                );

                updateStatus('ğŸ¯ ××—×¤×© ×‘×¨×§×•×“... ×›×•×•×Ÿ ××ª ×”×‘×¨×§×•×“ ×œ××¦×œ××”', 'info');
                
            } catch (error) {
                console.error('Start scanner error:', error);
                let errorMessage = '×©×’×™××” ×‘×”×¤×¢×œ×ª ×”××¦×œ××”';
                
                if (error.toString().includes('NotAllowedError')) {
                    errorMessage = '×”×’×™×©×” ×œ××¦×œ××” × ×“×—×ª×”. ×× × ××¤×©×¨ ×’×™×©×” ×œ××¦×œ××” ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ.';
                } else if (error.toString().includes('NotFoundError')) {
                    errorMessage = '×œ× × ××¦××” ××¦×œ××” ×‘××›×©×™×¨.';
                } else if (error.toString().includes('NotReadableError')) {
                    errorMessage = '×”××¦×œ××” ×‘×©×™××•×© ×¢×œ ×™×“×™ ××¤×œ×™×§×¦×™×” ××—×¨×ª.';
                }
                
                updateStatus(errorMessage, 'error');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('scanner-container').classList.add('hidden');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();
            
            // Prevent duplicate scans within 3 seconds
            if (lastDetected === decodedText && (now - lastDetectedTime) < 3000) {
                return;
            }
            
            lastDetected = decodedText;
            lastDetectedTime = now;
            
            console.log("Barcode detected:", decodedText);
            
            // Stop scanner
            stopScanner();
            
            // Show detected barcode
            document.getElementById('barcode-value').textContent = decodedText;
            document.getElementById('result').classList.remove('hidden');
            
            updateStatus('âœ… ×‘×¨×§×•×“ ×–×•×”×” ×‘×”×¦×œ×—×”!', 'success');
            
            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            
            // Send to Baby Land website
            sendToBabyLand(decodedText);
        }

        function onScanFailure(error) {
            // Don't log every frame failure - it's too noisy
            // console.warn(`Scan error: ${error}`);
        }

        async function stopScanner() {
            try {
                if (html5QrcodeScanner) {
                    await html5QrcodeScanner.stop();
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }
                
                document.getElementById('scanner-container').classList.add('hidden');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                updateStatus('×”×¡×¨×™×§×” ×”×•×¤×¡×§×”', 'info');
                
            } catch (error) {
                console.error('Stop scanner error:', error);
                // Force cleanup
                html5QrcodeScanner = null;
                document.getElementById('scanner-container').classList.add('hidden');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        async function sendToBabyLand(barcode) {
            try {
                // Copy to clipboard first
                try {
                    await navigator.clipboard.writeText(barcode);
                    updateStatus('âœ… ×”×‘×¨×§×•×“ ×”×•×¢×ª×§! ×¤×•×ª×— ××ª×¨...', 'success');
                } catch (e) {
                    console.log('Clipboard error:', e);
                    updateStatus('âœ… ×‘×¨×§×•×“: ' + barcode, 'success');
                }
                
                // Wait a moment
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Open the Baby Land page
                const babyLandUrl = 'https://event.baby-land.co.il/barcode/';
                window.open(babyLandUrl, '_blank');
                
                document.getElementById('loading').classList.add('hidden');
                
                // Show instructions
                updateStatus('ğŸ’¡ ×¢×‘×•×¨ ×œ×˜××‘ Baby Land ×•×”×“×‘×§ (×œ×—×™×¦×” ××¨×•×›×”). ×¡×•×¨×§ ××•×›×Ÿ ×œ×‘×¨×§×•×“ ×”×‘×!', 'info');
                
                // Auto restart scanner after 2 seconds
                setTimeout(() => {
                    document.getElementById('result').classList.add('hidden');
                    updateStatus('ğŸ”„ ××ª×—×™×œ ×¡×¨×™×§×” ××—×“×©...', 'info');
                    startScanner();
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('×”×‘×¨×§×•×“: ' + barcode + ' (×”×¢×ª×§ ×™×“× ×™×ª)', 'error');
                document.getElementById('loading').classList.add('hidden');
                
                // Restart scanner anyway
                setTimeout(() => {
                    document.getElementById('result').classList.add('hidden');
                    startScanner();
                }, 2000);
            }
        }

        function submitManualBarcode() {
            const input = document.getElementById('manual-input');
            const barcode = input.value.trim();
            
            if (!barcode) {
                alert('×× × ×”×–×Ÿ ×‘×¨×§×•×“');
                return;
            }
            
            // Show detected barcode
            document.getElementById('barcode-value').textContent = barcode;
            document.getElementById('result').classList.remove('hidden');
            
            updateStatus('âœ… ×‘×¨×§×•×“ ×”×•×–×Ÿ ×™×“× ×™×ª!', 'success');
            
            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            
            // Send to Baby Land website
            sendToBabyLand(barcode);
            
            // Clear input
            input.value = '';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop();
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button/message
            const installMessage = document.createElement('div');
            installMessage.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #667eea;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                cursor: pointer;
                animation: slideUp 0.3s ease;
            `;
            installMessage.innerHTML = 'ğŸ“± ×”×ª×§×Ÿ ××ª ×”××¤×œ×™×§×¦×™×” ×œ××¡×š ×”×‘×™×ª!';
            
            installMessage.addEventListener('click', async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                installMessage.remove();
            });
            
            document.body.appendChild(installMessage);
            
            // Remove message after 10 seconds
            setTimeout(() => {
                if (installMessage.parentNode) {
                    installMessage.remove();
                }
            }, 10000);
        });
    </script>
</body>
</html>
